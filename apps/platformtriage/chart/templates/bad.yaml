apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: bad-app
  name: bad-app
  namespace: cart
spec:
  replicas: 1
  selector:
    matchLabels:
      app: bad-app
  strategy: {}
  template:
    metadata:
      labels:
        app: bad-app
    spec:
      volumes:
      - name: restart-tracker
        emptyDir: {}
      containers:
      - image: busybox
        name: unstable-container
        command: ["/bin/sh", "-c"]
        args:
          - |
            # Use emptyDir to track restarts across container restarts (persists within pod lifetime)
            RESTART_FILE="/restart-state/count"
            mkdir -p /restart-state
            
            # Initialize counter if not exists
            if [ ! -f "$RESTART_FILE" ]; then
              echo "0" > "$RESTART_FILE"
            fi
            
            # Read current restart count
            RESTART_COUNT=$(cat "$RESTART_FILE")
            echo "=== Container Start #$RESTART_COUNT ==="
            
            # Crash for first 3 starts (creates 3 restarts), then stay stable
            if [ "$RESTART_COUNT" -lt "3" ]; then
              NEW_COUNT=$((RESTART_COUNT + 1))
              echo "âš ï¸  Simulating crash #$NEW_COUNT (will restart)..."
              echo "$NEW_COUNT" > "$RESTART_FILE"
              sleep 3
              echo "ðŸ’¥ Crashing now!"
              exit 1
            else
              echo "âœ… Stable! Running normally (restart history: $RESTART_COUNT)"
              # Keep container alive indefinitely
              while true; do
                sleep 30
                echo "Still running... (total restarts: $RESTART_COUNT)"
              done
            fi
        volumeMounts:
        - name: restart-tracker
          mountPath: /restart-state
        resources: {}
status: {}
